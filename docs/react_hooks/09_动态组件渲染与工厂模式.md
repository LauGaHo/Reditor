# åŠ¨æ€ç»„ä»¶æ¸²æŸ“ä¸å·¥å‚æ¨¡å¼ - é˜¶æ®µ3å®è·µæ€»ç»“

## æ¦‚è¿°

åœ¨é˜¶æ®µ3çš„å—ç±»å‹ç³»ç»Ÿå®ç°ä¸­ï¼Œæˆ‘ä»¬æ¥è§¦äº†å¤šä¸ªä¹‹å‰æœªä½¿ç”¨çš„ React ç‰¹æ€§å’Œè®¾è®¡æ¨¡å¼ã€‚è¿™äº›ç‰¹æ€§è®©æˆ‘ä»¬èƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªå¯æ‰©å±•ã€ç¬¦åˆå¼€é—­åŸåˆ™çš„ç»„ä»¶æ¶æ„ã€‚

## ğŸ†• æ–°æ¥è§¦çš„ React ç‰¹æ€§

### 1. åŠ¨æ€ç»„ä»¶æ¸²æŸ“

**æ¦‚å¿µï¼š** å°†ç»„ä»¶å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œå¹¶æ ¹æ®è¿è¡Œæ—¶æ¡ä»¶åŠ¨æ€é€‰æ‹©å’Œæ¸²æŸ“ç»„ä»¶

```typescript
// âœ… åŠ¨æ€ç»„ä»¶æ¸²æŸ“çš„å®ç°
const BlockFactoryComponent = ({ blockType, ...props }, ref) => {
  const registryItem = blockRegistry[blockType];
  const Component = registryItem.component; // åŠ¨æ€è·å–ç»„ä»¶

  return <Component ref={ref} {...props} />; // åŠ¨æ€æ¸²æŸ“ç»„ä»¶
};

// ä½¿ç”¨æ—¶
<BlockFactory blockType="h1" /> // æ¸²æŸ“ H1Block
<BlockFactory blockType="h2" /> // æ¸²æŸ“ H2Block
```

**æ ¸å¿ƒåŸç†ï¼š**
- React è¯†åˆ«é¦–å­—æ¯å¤§å†™çš„å˜é‡ä½œä¸ºç»„ä»¶
- ç»„ä»¶æœ¬è´¨ä¸Šæ˜¯å‡½æ•°ï¼Œå¯ä»¥åƒå…¶ä»–å€¼ä¸€æ ·å­˜å‚¨å’Œä¼ é€’
- JSX ä¸­çš„ `<Component />` ç­‰ä»·äº `React.createElement(Component)`

**åº”ç”¨åœºæ™¯ï¼š**
```typescript
// æ ¹æ®ç”¨æˆ·æƒé™æ¸²æŸ“ä¸åŒç»„ä»¶
const getComponentByRole = (role) => {
  const components = {
    admin: AdminPanel,
    user: UserPanel,
    guest: GuestPanel,
  };
  return components[role] || GuestPanel;
};

const DashboardComponent = ({ userRole }) => {
  const PanelComponent = getComponentByRole(userRole);
  return <PanelComponent />;
};
```

### 2. ç»„ä»¶å·¥å‚æ¨¡å¼

**æ¦‚å¿µï¼š** ä¸€ä¸ªç»„ä»¶æ ¹æ®è¾“å…¥å‚æ•°åˆ›å»ºå’Œé…ç½®ä¸åŒçš„å­ç»„ä»¶å®ä¾‹

```typescript
// å·¥å‚ç»„ä»¶çš„å®ç°
interface BlockFactoryProps extends BaseBlockProps {
  blockType: BlockType; // å†³å®šåˆ›å»ºå“ªç§ç»„ä»¶
}

const BlockFactory = ({ blockType, ...props }) => {
  // æ ¹æ®ç±»å‹é€‰æ‹©ç»„ä»¶
  const registryItem = blockRegistry[blockType] || blockRegistry.paragraph;
  const Component = registryItem.component;

  return <Component {...props} />;
};
```

**ä¸ä¼ ç»Ÿæ¡ä»¶æ¸²æŸ“çš„å¯¹æ¯”ï¼š**
```typescript
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼šè¿åå¼€é—­åŸåˆ™
const BlockRenderer = ({ blockType, ...props }) => {
  if (blockType === 'paragraph') return <ParagraphBlock {...props} />;
  if (blockType === 'h1') return <H1Block {...props} />;
  if (blockType === 'h2') return <H2Block {...props} />;
  // æ¯æ¬¡æ–°å¢ç±»å‹éƒ½è¦ä¿®æ”¹è¿™é‡Œ
};

// âœ… å·¥å‚æ¨¡å¼ï¼šç¬¦åˆå¼€é—­åŸåˆ™
const BlockFactory = ({ blockType, ...props }) => {
  const Component = blockRegistry[blockType]?.component || ParagraphBlock;
  return <Component {...props} />;
};
```

### 3. ç»„ä»¶æ³¨å†Œç³»ç»Ÿ

**æ¦‚å¿µï¼š** å°†ç»„ä»¶ä½œä¸ºé…ç½®æ•°æ®å­˜å‚¨ï¼Œå®ç°æ’ä»¶åŒ–æ¶æ„

```typescript
// æ³¨å†Œè¡¨æ•°æ®ç»“æ„
interface BlockRegistryItem {
  component: React.ForwardRefExoticComponent<BaseBlockProps & React.RefAttributes<BlockHandle>>;
  displayName: string;
  icon?: string;
  defaultContent?: string;
}

// æ³¨å†Œè¡¨å®ç°
const blockRegistry: Record<BlockType, BlockRegistryItem> = {
  paragraph: {
    component: ParagraphBlock,
    displayName: "æ®µè½",
    defaultContent: "",
  },
  h1: {
    component: H1Block,
    displayName: "æ ‡é¢˜ 1",
    defaultContent: "",
  },
  // æ–°å¢ç±»å‹åªéœ€åœ¨è¿™é‡Œæ³¨å†Œ
};

// å·¥å…·å‡½æ•°
export const getBlockDisplayName = (type: BlockType): string => {
  return blockRegistry[type]?.displayName || "æœªçŸ¥ç±»å‹";
};

export const getAvailableBlockTypes = (): BlockType[] => {
  return Object.keys(blockRegistry) as BlockType[];
};
```

**æ‰©å±•æ€§ä¼˜åŠ¿ï¼š**
```typescript
// æ–°å¢å—ç±»å‹çš„å®Œæ•´æµç¨‹
// 1. å®šä¹‰æ–°ç±»å‹
export type BlockType = 'paragraph' | 'h1' | 'h2' | 'h3' | 'codeBlock'; // æ–°å¢

// 2. åˆ›å»ºç»„ä»¶
const CodeBlock = forwardRef<BlockHandle, BaseBlockProps>(...);

// 3. æ³¨å†Œç»„ä»¶
const blockRegistry = {
  // ... ç°æœ‰ç±»å‹
  codeBlock: {
    component: CodeBlock,
    displayName: "ä»£ç å—",
    defaultContent: "",
  },
};

// 4. æ— éœ€ä¿®æ”¹ä»»ä½•ç°æœ‰ä»£ç ï¼
```

### 4. é«˜é˜¶ç»„ä»¶åŒ…è£…æ¨¡å¼

**æ¦‚å¿µï¼š** åˆ›å»ºåŒ…è£…ç»„ä»¶æ¥é¢„è®¾ç‰¹å®šçš„ propsï¼Œå®ç°ç»„ä»¶çš„å‚æ•°åŒ–å¤ç”¨

```typescript
// åŸºç¡€ç»„ä»¶
interface HeadingBlockProps extends BaseBlockProps {
  headingLevel: 'h1' | 'h2' | 'h3';
}

const HeadingBlock = ({ headingLevel, ...props }) => {
  const HeadingElement = headingLevel; // åŠ¨æ€æ ‡ç­¾
  return <HeadingElement {...props} />;
};

// åŒ…è£…ç»„ä»¶ - é¢„è®¾å‚æ•°
const H1Block = forwardRef<BlockHandle, BaseBlockProps>((props, ref) => (
  <HeadingBlock {...props} ref={ref} headingLevel="h1" />
));

const H2Block = forwardRef<BlockHandle, BaseBlockProps>((props, ref) => (
  <HeadingBlock {...props} ref={ref} headingLevel="h2" />
));
```

**å¤ç”¨æ€§ä¼˜åŠ¿ï¼š**
```typescript
// ä¸€ä¸ªåŸºç¡€ç»„ä»¶ï¼Œå¤šä¸ªåŒ…è£…å™¨
const ButtonBase = ({ variant, size, children, ...props }) => (
  <button className={`btn-${variant} btn-${size}`} {...props}>
    {children}
  </button>
);

// åˆ›å»ºä¸“ç”¨æŒ‰é’®
const PrimaryButton = (props) => <ButtonBase variant="primary" {...props} />;
const SecondaryButton = (props) => <ButtonBase variant="secondary" {...props} />;
const LargeButton = (props) => <ButtonBase size="large" {...props} />;
```

### 5. åŠ¨æ€æ ·å¼æ¸²æŸ“

**æ¦‚å¿µï¼š** æ ¹æ® props åŠ¨æ€è®¡ç®—æ ·å¼å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç æ ·å¼

```typescript
const HeadingBlock = ({ headingLevel, ...props }) => {
  // åŠ¨æ€æ ·å¼è®¡ç®—
  const getHeadingStyle = () => {
    const baseStyle = {
      fontWeight: "bold" as const,
      marginBottom: "8px",
    };

    switch (headingLevel) {
      case 'h1':
        return { ...baseStyle, fontSize: "32px", lineHeight: "1.2" };
      case 'h2':
        return { ...baseStyle, fontSize: "24px", lineHeight: "1.3" };
      case 'h3':
        return { ...baseStyle, fontSize: "20px", lineHeight: "1.4" };
      default:
        return baseStyle;
    }
  };

  // åŠ¨æ€æ ‡ç­¾å
  const HeadingElement = headingLevel;

  return (
    <HeadingElement
      style={getHeadingStyle()}
      {...props}
    />
  );
};
```

**æ€§èƒ½è€ƒè™‘ï¼š**
```typescript
// âŒ æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å¯¹è±¡
const BadComponent = ({ size }) => (
  <div style={{ fontSize: size === 'large' ? '24px' : '16px' }} />
);

// âœ… ä½¿ç”¨ useMemo ç¼“å­˜æ ·å¼å¯¹è±¡
const GoodComponent = ({ size }) => {
  const style = useMemo(() => ({
    fontSize: size === 'large' ? '24px' : '16px'
  }), [size]);

  return <div style={style} />;
};
```

### 6. å¤æ‚çš„ TypeScript ç±»å‹å®šä¹‰

**æ¦‚å¿µï¼š** ç¡®ä¿ç»„ä»¶æ³¨å†Œè¡¨çš„ç±»å‹å®‰å…¨

```typescript
// å¤æ‚çš„ç»„ä»¶ç±»å‹å®šä¹‰
interface BlockRegistryItem {
  component: React.ForwardRefExoticComponent<
    BaseBlockProps & React.RefAttributes<BlockHandle>
  >;
  displayName: string;
  icon?: string;
  defaultContent?: string;
}

// ç±»å‹è§£æï¼š
// - React.ForwardRefExoticComponent: forwardRef åˆ›å»ºçš„ç»„ä»¶ç±»å‹
// - BaseBlockProps: åŸºç¡€ props ç±»å‹
// - React.RefAttributes<BlockHandle>: ref å±æ€§ç±»å‹
// - BlockHandle: ref å¯¹è±¡çš„æ¥å£ç±»å‹
```

**ç±»å‹å®‰å…¨çš„å¥½å¤„ï¼š**
```typescript
// TypeScript ä¼šåœ¨ç¼–è¯‘æ—¶æ£€æŸ¥ç±»å‹åŒ¹é…
const registry: Record<BlockType, BlockRegistryItem> = {
  paragraph: {
    component: ParagraphBlock, // âœ… ç±»å‹åŒ¹é…
    displayName: "æ®µè½",
  },
  h1: {
    component: "invalid", // âŒ TypeScript é”™è¯¯ï¼šç±»å‹ä¸åŒ¹é…
    displayName: "æ ‡é¢˜ 1",
  },
};
```

### 7. äº‹ä»¶å§”æ‰˜æ¨¡å¼

**æ¦‚å¿µï¼š** å°†çŠ¶æ€ç®¡ç†é€»è¾‘æå‡åˆ°çˆ¶ç»„ä»¶ï¼Œå­ç»„ä»¶åªè´Ÿè´£äº‹ä»¶è§¦å‘

```typescript
// çˆ¶ç»„ä»¶ - å¤„ç†æ‰€æœ‰çŠ¶æ€å˜æ›´
const MultiBlockEditor = () => {
  const [blocks, setBlocks] = useState<BlockData[]>([]);

  const handleTypeChange = useCallback((blockId: string, newType: BlockType) => {
    setBlocks(prevBlocks =>
      prevBlocks.map(block =>
        block.id === blockId ? { ...block, type: newType } : block
      )
    );
  }, []);

  return (
    <div>
      {blocks.map(block => (
        <BlockWrapper
          key={block.id}
          block={block}
          onTypeChange={handleTypeChange} // ä¼ é€’äº‹ä»¶å¤„ç†å™¨
        />
      ))}
    </div>
  );
};

// å­ç»„ä»¶ - åªè´Ÿè´£è§¦å‘äº‹ä»¶
const BlockTypeSelector = ({ currentType, onTypeChange }) => {
  const handleSelect = (type) => {
    onTypeChange(type); // å‘ä¸Šå§”æ‰˜
  };

  return <select onChange={handleSelect} />;
};
```

### 8. æ¡ä»¶æ¸²æŸ“ä¸äº¤äº’çŠ¶æ€

**æ¦‚å¿µï¼š** åŸºäºç”¨æˆ·äº¤äº’çš„æ¡ä»¶æ¸²æŸ“

```typescript
const BlockWrapper = ({ block, ...props }) => {
  const [showTypeSelector, setShowTypeSelector] = useState(false);

  return (
    <div
      onMouseEnter={() => setShowTypeSelector(true)}
      onMouseLeave={() => setShowTypeSelector(false)}
    >
      {/* æ¡ä»¶æ¸²æŸ“ - åªåœ¨é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤º */}
      {showTypeSelector && (
        <BlockTypeSelector
          currentType={block.type}
          onTypeChange={(newType) => props.onTypeChange?.(block.id, newType)}
        />
      )}

      <BlockFactory blockType={block.type} {...props} />
    </div>
  );
};
```

## ğŸ— è®¾è®¡æ¨¡å¼æ€»ç»“

### 1. å·¥å‚æ¨¡å¼ (Factory Pattern)
- **åº”ç”¨ï¼š** `BlockFactory` æ ¹æ®ç±»å‹åˆ›å»ºç»„ä»¶
- **ä¼˜åŠ¿ï¼š** è§£è€¦ç»„ä»¶åˆ›å»ºé€»è¾‘ï¼Œæ˜“äºæ‰©å±•

### 2. æ³¨å†Œæ¨¡å¼ (Registry Pattern)
- **åº”ç”¨ï¼š** `blockRegistry` ç®¡ç†ç»„ä»¶æ˜ å°„
- **ä¼˜åŠ¿ï¼š** æ’ä»¶åŒ–æ¶æ„ï¼Œè¿è¡Œæ—¶å¯æ‰©å±•

### 3. åŒ…è£…å™¨æ¨¡å¼ (Wrapper Pattern)
- **åº”ç”¨ï¼š** `BlockWrapper` æ·»åŠ äº¤äº’åŠŸèƒ½
- **ä¼˜åŠ¿ï¼š** å…³æ³¨ç‚¹åˆ†ç¦»ï¼ŒåŠŸèƒ½æ¨¡å—åŒ–

### 4. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
- **åº”ç”¨ï¼š** ä¸åŒå—ç±»å‹çš„æ¸²æŸ“ç­–ç•¥
- **ä¼˜åŠ¿ï¼š** ç®—æ³•å¯æ›¿æ¢ï¼Œæ˜“äºç»´æŠ¤

## ğŸ“š å­¦ä¹ ä»·å€¼

### æ ¸å¿ƒæ”¶è·

1. **æ¶æ„è®¾è®¡æ€ç»´**
   - å¼€é—­åŸåˆ™çš„å®é™…åº”ç”¨
   - ç»„ä»¶åŒ–è®¾è®¡çš„é«˜çº§æ¨¡å¼
   - å¯æ‰©å±•ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•

2. **React é«˜çº§ç‰¹æ€§**
   - åŠ¨æ€ç»„ä»¶æ¸²æŸ“çš„åŸç†å’Œåº”ç”¨
   - ç»„ä»¶å·¥å‚æ¨¡å¼çš„å®ç°
   - å¤æ‚ TypeScript ç±»å‹ç³»ç»Ÿ

3. **æ€§èƒ½ä¼˜åŒ–**
   - memo + useCallback åœ¨å¤æ‚åœºæ™¯çš„åº”ç”¨
   - å¼•ç”¨ç¨³å®šæ€§åœ¨åŠ¨æ€ç»„ä»¶ä¸­çš„é‡è¦æ€§

### å®é™…åº”ç”¨åœºæ™¯

è¿™äº›æ¨¡å¼åœ¨å®é™…å¼€å‘ä¸­çš„åº”ç”¨ï¼š

- **CMS ç³»ç»Ÿ** - åŠ¨æ€é¡µé¢ç»„ä»¶
- **å¯è§†åŒ–ç¼–è¾‘å™¨** - æ‹–æ‹½ç»„ä»¶ç³»ç»Ÿ
- **ä»ªè¡¨æ¿ç³»ç»Ÿ** - å¯é…ç½®å›¾è¡¨ç»„ä»¶
- **è¡¨å•æ„å»ºå™¨** - åŠ¨æ€è¡¨å•å­—æ®µ

## ğŸš€ ä¸‹ä¸€æ­¥æ‰©å±•

åŸºäºå½“å‰æ¶æ„ï¼Œæœªæ¥å¯ä»¥è½»æ¾æ‰©å±•ï¼š

```typescript
// æ‰©å±•ç¤ºä¾‹ï¼šæ·»åŠ åˆ—è¡¨å’Œåª’ä½“å—
export type BlockType =
  | 'paragraph' | 'h1' | 'h2' | 'h3'
  | 'bulletList' | 'numberedList'  // åˆ—è¡¨ç±»å‹
  | 'image' | 'video' | 'embed';   // åª’ä½“ç±»å‹

// åªéœ€æ·»åŠ ç»„ä»¶å’Œæ³¨å†Œï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
const blockRegistry = {
  // ... ç°æœ‰ç±»å‹
  bulletList: {
    component: BulletListBlock,
    displayName: "æ— åºåˆ—è¡¨",
  },
  image: {
    component: ImageBlock,
    displayName: "å›¾ç‰‡",
  },
};
```

## æ€»ç»“

é˜¶æ®µ3ä¸ä»…å®ç°äº†å—ç±»å‹ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œæ›´é‡è¦çš„æ˜¯å­¦ä¹ äº†**å¯æ‰©å±•æ¶æ„è®¾è®¡**çš„æ€ç»´æ–¹å¼ã€‚è¿™äº›æ¨¡å¼å’Œç‰¹æ€§ä¸ºåç»­æ›´å¤æ‚çš„åŠŸèƒ½ï¼ˆå¦‚æ‹–æ‹½ã€å‘½ä»¤ç³»ç»Ÿç­‰ï¼‰å¥ å®šäº†åšå®åŸºç¡€ã€‚

React çš„å¼ºå¤§ä¹‹å¤„åœ¨äºå…¶çµæ´»æ€§ - ç»„ä»¶å³æ•°æ®ï¼Œæ•°æ®å³ç»„ä»¶ã€‚æŒæ¡äº†è¿™ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå°±èƒ½æ„å»ºå‡ºæ— é™å¯èƒ½çš„åº”ç”¨æ¶æ„ã€‚